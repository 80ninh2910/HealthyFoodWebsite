<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="../../css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #f7f4ee; }
        .analytics-content { max-width: 100%; }
        .analytics-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: #333; }
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .metric-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #7A205C; }
        .metric-label { color: #666; margin-top: 5px; }
        .metric-change { font-size: 0.9rem; margin-top: 5px; }
        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .period-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .period-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; }
        .period-btn.active { background: #7A205C; color: white; border-color: #7A205C; }
    </style>
</head>
<body>
    <div class="analytics-content">
        <!-- Period Selector -->
        <div class="period-selector">
            <button class="period-btn active" data-period="7d">Last 7 Days</button>
            <button class="period-btn" data-period="30d">Last 30 Days</button>
            <button class="period-btn" data-period="90d">Last 90 Days</button>
            <button class="period-btn" data-period="1y">Last Year</button>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalRevenue">₫0</div>
                <div class="metric-label">Total Revenue</div>
                <div class="metric-change positive" id="revenueChange">+12.5%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalOrders">0</div>
                <div class="metric-label">Total Orders</div>
                <div class="metric-change positive" id="ordersChange">+8.2%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgOrderValue">₫0</div>
                <div class="metric-label">Avg Order Value</div>
                <div class="metric-change positive" id="aovChange">+4.1%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="customerCount">0</div>
                <div class="metric-label">New Customers</div>
                <div class="metric-change positive" id="customerChange">+15.3%</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="analytics-grid">
            <div class="chart-container">
                <div class="chart-title">Revenue Trend</div>
                <canvas id="revenueChart" height="300"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Order Status Distribution</div>
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="analytics-grid">
            <div class="chart-container">
                <div class="chart-title">Top Selling Products</div>
                <canvas id="productsChart" height="300"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Customer Acquisition</div>
                <canvas id="customersChart" height="300"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="chart-title">Daily Performance</div>
            <div class="table-wrap">
                <table id="analyticsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Revenue</th>
                            <th>Orders</th>
                            <th>New Customers</th>
                            <th>Avg Order Value</th>
                            <th>Conversion Rate</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAnalyticsData();
            initCharts();
            initPeriodSelector();
        });

        async function loadAnalyticsData() {
            try {
                const data = await fetch('../../json/admin_data.json').then(r => r.json()).catch(() => null);
                
                if (data) {
                    // Update metrics
                    document.getElementById('totalRevenue').textContent = `₫${data.kpis.sales}`;
                    document.getElementById('totalOrders').textContent = data.kpis.orders;
                    document.getElementById('avgOrderValue').textContent = `₫${Math.floor(Math.random() * 50000) + 100000}`;
                    document.getElementById('customerCount').textContent = Math.floor(Math.random() * 100) + 50;

                    // Populate daily performance table
                    const tbody = document.getElementById('analyticsTableBody');
                    tbody.innerHTML = '';
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${dateStr}</td>
                            <td>₫${(Math.random() * 1000000 + 500000).toLocaleString()}</td>
                            <td>${Math.floor(Math.random() * 50) + 20}</td>
                            <td>${Math.floor(Math.random() * 10) + 5}</td>
                            <td>₫${(Math.random() * 50000 + 100000).toLocaleString()}</td>
                            <td>${(Math.random() * 5 + 2).toFixed(1)}%</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        function initCharts() {
            // Revenue Trend Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [1200000, 1500000, 1100000, 1800000, 2000000, 1600000, 1400000],
                        borderColor: '#7A205C',
                        backgroundColor: 'rgba(122, 32, 92, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
                }
            });

            // Order Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Processing', 'Cancelled'],
                    datasets: [{
                        data: [65, 20, 10, 5],
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Top Products Chart
            const productsCtx = document.getElementById('productsChart').getContext('2d');
            new Chart(productsCtx, {
                type: 'bar',
                data: {
                    labels: ['Balanced Bowl', 'High Protein', 'Low Calorie', 'Vegetarian', 'Custom Bowl'],
                    datasets: [{
                        label: 'Sales',
                        data: [120, 95, 80, 60, 45],
                        backgroundColor: '#7A205C'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
                }
            });

            // Customer Acquisition Chart
            const customersCtx = document.getElementById('customersChart').getContext('2d');
            new Chart(customersCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Customers',
                        data: [45, 52, 38, 65, 58, 72],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
                }
            });
        }

        function initPeriodSelector() {
            const periodBtns = document.querySelectorAll('.period-btn');
            
            periodBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    periodBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const period = btn.getAttribute('data-period');
                    updateAnalyticsForPeriod(period);
                });
            });
        }

        function updateAnalyticsForPeriod(period) {
            // This would typically make an API call to get data for the selected period
            console.log(`Updating analytics for period: ${period}`);
            // For now, just reload the data
            loadAnalyticsData();
        }
    </script>
</body>
</html>
